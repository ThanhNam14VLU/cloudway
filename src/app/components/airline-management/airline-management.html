<div class="flight-management">
  <div class="header">
    <h2>Qu·∫£n l√Ω chuy·∫øn bay</h2>
    <p>Th√™m, ch·ªânh s·ª≠a v√† qu·∫£n l√Ω c√°c chuy·∫øn bay c·ªßa h√£ng</p>
    <button class="add-flight" (click)="ShowForm()">+ Th√™m chuy·∫øn bay</button>
  </div>

  <div class="search-filter">
    <input 
      type="text" 
      placeholder="T√¨m ki·∫øm theo s·ªë hi·ªáu ho·∫∑c tuy·∫øn bay..." 
      [(ngModel)]="searchTerm"
      (input)="onSearchChange()"
    />
    <select 
      class="flight-state" 
      [(ngModel)]="selectedStatus"
      (change)="onStatusFilterChange()"
    >
      @for (option of getStatusOptions(); track option.value) {
        <option [value]="option.value">{{ option.label }}</option>
      }
    </select>
    <button 
      class="clear-filters" 
      (click)="clearFilters()"
      [disabled]="!selectedStatus && !searchTerm"
      title="X√≥a b·ªô l·ªçc"
    >
      üßπ X√≥a l·ªçc
    </button>
  </div>

  <!-- Filter Results Info -->
  @if (allFlights.length > 0 && (selectedStatus || searchTerm)) {
    <div class="filter-info">
      <p>
        Hi·ªÉn th·ªã {{ flights.length }} / {{ allFlights.length }} chuy·∫øn bay
        @if (selectedStatus) {
          <span class="filter-tag">Tr·∫°ng th√°i: {{ getFlightStatusText(selectedStatus) }}</span>
        }
        @if (searchTerm) {
          <span class="filter-tag">T√¨m ki·∫øm: "{{ searchTerm }}"</span>
        }
      </p>
    </div>
  }

  <div class="flight-list">
    @if (isLoading) {
      <div class="loading">
        <p>ƒêang t·∫£i danh s√°ch chuy·∫øn bay...</p>
      </div>
    } @else {
      <table>
        <thead>
          <tr>
            <th>S·ªë hi·ªáu</th>
            <th>Tuy·∫øn bay</th>
            <th>L·ªãch tr√¨nh</th>
            <th>M√°y bay</th>
            <th>S·ª©c ch·ª©a</th>
            <th>Ng√†y bay</th>
            <th>Tr·∫°ng th√°i</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody>
          @if (flights.length === 0) {
            <tr>
              <td colspan="8" class="no-data">
                @if (allFlights.length === 0) {
                  <p>Ch∆∞a c√≥ chuy·∫øn bay n√†o</p>
                  <button class="add-flight-btn" (click)="ShowForm()">+ Th√™m chuy·∫øn bay ƒë·∫ßu ti√™n</button>
                } @else {
                  <p>Kh√¥ng t√¨m th·∫•y chuy·∫øn bay n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc</p>
                  <button class="clear-filters-btn" (click)="clearFilters()">üßπ X√≥a b·ªô l·ªçc</button>
                }
              </td>
            </tr>
          } @else {
            @for (flight of flights; track flight.id) {
              <tr>
                <td>{{ flight.flight_number.code }}</td>
                <td>
                  {{ flight.flight_number.departure_airport.city }} <span class="arrow">‚úà</span> {{ flight.flight_number.arrival_airport.city }}
                  <div class="airport-code">{{ flight.flight_number.departure_airport.iata_code }} ‚Üí {{ flight.flight_number.arrival_airport.iata_code }}</div>
                </td>
                <td>
                  {{ formatTime(flight.scheduled_departure_local) }} - {{ formatTime(flight.scheduled_arrival_local) }}
                  <div class="duration">{{ calculateDuration(flight.scheduled_departure_local, flight.scheduled_arrival_local) }}</div>
                </td>
                <td>{{ flight.aircraft.type }}</td>
                <td>{{ flight.aircraft.seat_capacity }}</td>
                <td>{{ formatFlightDate(flight.scheduled_departure_local) }}</td>
                <td>
                  <span class="status-badge" [class.cancelled]="flight.status === 'CANCELLED'" [class.active]="flight.status !== 'CANCELLED'">
                    {{ getFlightStatusText(flight.status) }}
                  </span>
                </td>
                <td>
                  <div class="action-buttons">
                    <button class="edit" title="Ch·ªânh s·ª≠a" (click)="editFlight(flight)">
                      <span class="icon">‚úèÔ∏è</span>
                      <span class="text">S·ª≠a</span>
                    </button>
                    <button 
                      class="cancel" 
                      [title]="canCancelFlight(flight) ? 'H·ªßy chuy·∫øn' : 'Kh√¥ng th·ªÉ h·ªßy chuy·∫øn ƒë√£ kh·ªüi h√†nh/ƒë·∫øn'"
                      (click)="cancelFlight(flight)" 
                      [disabled]="!canCancelFlight(flight)"
                    >
                      <span class="icon">‚ùå</span>
                      <span class="text">{{ getCancelButtonText(flight) }}</span>
                    </button>
                    <!-- <button class="delete" title="X√≥a vƒ©nh vi·ªÖn" (click)="deleteFlight(flight)">
                      <span class="icon">üóëÔ∏è</span>
                      <span class="text">X√≥a</span>
                    </button> -->
                  </div>
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
    }
  </div>
</div>
@if(isShowForm){
  <app-airline-add-flight-form 
    (close)="CloseForm()" 
    (success)="onFlightFormSuccess()" 
    (error)="onFlightFormError($event)">
  </app-airline-add-flight-form><!--khi nh·∫≠n ƒë∆∞·ª£c s·ª± ki·ªán t·ª´ con th√¨ g·ªçi CloseForm-->
}

<!-- Edit Flight Modal -->
@if(showEditModal) {
  <div class="modal-overlay" (click)="closeEditModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Ch·ªânh s·ª≠a chuy·∫øn bay</h3>
        <button class="close-btn" (click)="closeEditModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="flight-info">
          <h4>{{ selectedFlight?.flight_number?.code }}</h4>
          <p>{{ selectedFlight?.flight_number?.departure_airport?.city }} ‚Üí {{ selectedFlight?.flight_number?.arrival_airport?.city }}</p>
          <p>{{ formatTime(selectedFlight?.scheduled_departure_local) }} - {{ formatTime(selectedFlight?.scheduled_arrival_local) }}</p>
        </div>
        <div class="form-group">
          <label>Th·ªùi gian kh·ªüi h√†nh m·ªõi:</label>
          <input type="datetime-local" [(ngModel)]="selectedFlight.scheduled_departure_local" />
        </div>
        <div class="form-group">
          <label>Th·ªùi gian ƒë·∫øn m·ªõi:</label>
          <input type="datetime-local" [(ngModel)]="selectedFlight.scheduled_arrival_local" />
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeEditModal()" [disabled]="isUpdating">H·ªßy</button>
        <button class="btn btn-primary" (click)="saveFlightChanges()" [disabled]="isUpdating">
          <span *ngIf="isUpdating">ƒêang c·∫≠p nh·∫≠t...</span>
          <span *ngIf="!isUpdating">L∆∞u thay ƒë·ªïi</span>
        </button>
      </div>
    </div>
  </div>
}

<!-- Cancel Flight Modal -->
@if(showCancelModal) {
  <div class="modal-overlay" (click)="closeCancelModal()">
    <div class="modal-content cancel-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>H·ªßy chuy·∫øn bay</h3>
        <button class="close-btn" (click)="closeCancelModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="warning-icon">‚ö†Ô∏è</div>
        <h4>X√°c nh·∫≠n h·ªßy chuy·∫øn bay</h4>
        <div class="flight-details">
          <p><strong>S·ªë hi·ªáu:</strong> {{ selectedFlight?.flight_number?.code }}</p>
          <p><strong>Tuy·∫øn bay:</strong> {{ selectedFlight?.flight_number?.departure_airport?.city }} ‚Üí {{ selectedFlight?.flight_number?.arrival_airport?.city }}</p>
          <p><strong>Ng√†y bay:</strong> {{ formatFlightDate(selectedFlight?.scheduled_departure_local) }}</p>
          <p><strong>Gi·ªù bay:</strong> {{ formatTime(selectedFlight?.scheduled_departure_local) }}</p>
        </div>
        <!-- <p class="warning-text">H√†nh kh√°ch s·∫Ω ƒë∆∞·ª£c th√¥ng b√°o v·ªÅ vi·ªác h·ªßy chuy·∫øn v√† c√≥ th·ªÉ ƒë·ªïi/h·ªßy v√©.</p> -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeCancelModal()" [disabled]="isCancelling">Kh√¥ng h·ªßy</button>
        <button class="btn btn-danger" (click)="confirmCancelFlight()" [disabled]="isCancelling">
          <span *ngIf="isCancelling">ƒêang h·ªßy...</span>
          <span *ngIf="!isCancelling">X√°c nh·∫≠n h·ªßy</span>
        </button>
      </div>
    </div>
  </div>
}

<!-- Delete Flight Modal -->
@if(showDeleteModal) {
  <div class="modal-overlay" (click)="closeDeleteModal()">
    <div class="modal-content delete-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>X√≥a chuy·∫øn bay</h3>
        <button class="close-btn" (click)="closeDeleteModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="danger-icon">üóëÔ∏è</div>
        <h4>X√°c nh·∫≠n x√≥a vƒ©nh vi·ªÖn</h4>
        <div class="flight-details">
          <p><strong>S·ªë hi·ªáu:</strong> {{ selectedFlight?.flight_number?.code }}</p>
          <p><strong>Tuy·∫øn bay:</strong> {{ selectedFlight?.flight_number?.departure_airport?.city }} ‚Üí {{ selectedFlight?.flight_number?.arrival_airport?.city }}</p>
          <p><strong>Ng√†y bay:</strong> {{ formatFlightDate(selectedFlight?.scheduled_departure_local) }}</p>
          <p><strong>Gi·ªù bay:</strong> {{ formatTime(selectedFlight?.scheduled_departure_local) }}</p>
        </div>
        <p class="danger-text">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c. Chuy·∫øn bay s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn kh·ªèi h·ªá th·ªëng.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeDeleteModal()">Kh√¥ng x√≥a</button>
        <button class="btn btn-danger" (click)="confirmDeleteFlight()">X√°c nh·∫≠n x√≥a</button>
      </div>
    </div>
  </div>
}

<!-- Notification Dialog -->
<app-notification-dialog
  [visible]="showNotificationDialog"
  [type]="notificationType"
  [title]="notificationTitle"
  [message]="notificationMessage"
  (confirm)="closeNotificationDialog()"
  (close)="closeNotificationDialog()">
</app-notification-dialog>