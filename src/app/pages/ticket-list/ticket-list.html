<div class="ticket-list-container">
  <app-header></app-header>
  <!-- Header with search parameters -->
  <div class="search-header">
    <div class="search-params">
      <!-- Top control bar -->
      <div class="top-controls">
        <div class="trip-type" (click)="toggleTripType()">
          <mat-icon>{{ tripType === 'oneway' ? 'swap_horiz' : 'swap_horiz' }}</mat-icon>
          <span>{{ tripType === 'oneway' ? 'Một chiều' : 'Khứ hồi' }}</span>
        </div>
        
        <div class="passenger-selector" (click)="onPassengerSelectorClick($event)">
          <mat-icon>person</mat-icon>
          <span>{{ getTotalPassengers() }}</span>
          <mat-icon [class.rotated]="showPassengerDropdown">keyboard_arrow_down</mat-icon>
          
          <!-- Passenger Dropdown -->
          <div class="passenger-dropdown" [class.show]="showPassengerDropdown" (click)="$event.stopPropagation()">
            <div class="passenger-option">
              <div class="passenger-info">
                <mat-icon>person</mat-icon>
                <span>Người lớn</span>
              </div>
              <div class="passenger-controls">
                <button type="button" (click)="decrementAdults(); $event.stopPropagation()" [disabled]="passengers.adults <= 1">-</button>
                <span>{{ passengers.adults }}</span>
                <button type="button" (click)="incrementAdults(); $event.stopPropagation()">+</button>
              </div>
            </div>
            
            <div class="passenger-option">
              <div class="passenger-info">
                <mat-icon>person</mat-icon>
                <span>Trẻ em</span>
              </div>
              <div class="passenger-controls">
                <button type="button" (click)="decrementChildren(); $event.stopPropagation()" [disabled]="passengers.children <= 0">-</button>
                <span>{{ passengers.children }}</span>
                <button type="button" (click)="incrementChildren(); $event.stopPropagation()">+</button>
              </div>
            </div>
            
            <div class="passenger-option">
              <div class="passenger-info">
                <mat-icon>person</mat-icon>
                <span>Em bé</span>
              </div>
              <div class="passenger-controls">
                <button type="button" (click)="decrementInfants(); $event.stopPropagation()" [disabled]="passengers.infants <= 0">-</button>
                <span>{{ passengers.infants }}</span>
                <button type="button" (click)="incrementInfants(); $event.stopPropagation()">+</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- <mat-checkbox class="cheapest-month">
          Vé rẻ nhất tháng
        </mat-checkbox> -->
      </div>
      
      <!-- Search form -->
      <div class="search-form" [class.roundtrip]="tripType === 'roundtrip'">
        <div class="form-group input-wrapper">
          <label>Điểm đi</label>
          <mat-icon>flight_takeoff</mat-icon>
          <select [(ngModel)]="searchParams.departure" (change)="searchFlights()">
            <option value="" disabled>Chọn điểm đi</option>
            @for (airport of airports; track airport.id) {
              <option [value]="airport.iata_code">
                {{ airport.city }} - {{ airport.name }} ({{ airport.iata_code }})
              </option>
            }
          </select>
        </div>
        
        <div class="form-group input-wrapper">
          <label>Điểm đến</label>
          <mat-icon>flight_land</mat-icon>
          <select [(ngModel)]="searchParams.destination" (change)="searchFlights()">
            <option value="" disabled>Chọn điểm đến</option>
            @for (airport of airports; track airport.id) {
              <option [value]="airport.iata_code">
                {{ airport.city }} - {{ airport.name }} ({{ airport.iata_code }})
              </option>
            }
          </select>
        </div>
        
        <div class="form-group">
          <label>Ngày đi</label>
          <input type="date" [(ngModel)]="searchParams.departureDate" (change)="searchFlights()" />
        </div>
        
        <div class="form-group" *ngIf="tripType === 'roundtrip'">
          <label>Ngày về</label>
          <input type="date" [(ngModel)]="searchParams.returnDate" (change)="searchFlights()" />
        </div>
        
        <button matButton="filled" (click)="searchFlights()">
          Tìm kiếm
        </button>
      </div>
    </div>

    <!-- Flight Selection Status -->
    <div class="selection-status" *ngIf="searchResult && (apiFlights.length > 0 || apiReturnFlights.length > 0)">
      <div class="status-info">
        <div class="departure-status" [class.completed]="selectedDepartureFlight">
          <mat-icon>{{ selectedDepartureFlight ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
          <span>Chuyến đi: {{ selectedDepartureFlight ? selectedDepartureFlight.code : 'Chưa chọn' }}</span>
        </div>
        <div class="return-status" *ngIf="tripType === 'roundtrip'" [class.completed]="selectedReturnFlight">
          <mat-icon>{{ selectedReturnFlight ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
          <span>Chuyến về: {{ selectedReturnFlight ? selectedReturnFlight.code : 'Chưa chọn' }}</span>
        </div>
      </div>
      <div class="proceed-section">
        <!-- <div class="total-price" *ngIf="getTotalPrice() > 0">
          Tổng cộng: {{ formatPrice(getTotalPrice()) }}
        </div> -->
        <button class="proceed-btn" (click)="proceedToBooking()">
          Tiếp tục đặt vé
        </button>
      </div>
    </div>
  </div>

  <!-- Main content -->
  <div class="main-content">
    <!-- Left sidebar - Filters -->
    <div class="sidebar">
      <div class="filter-section">
        <h3>Lọc kết quả</h3>
        <div class="filter-group">
          <div class="filter-header">
            <h4>Hiển thị theo</h4>
            <button type="button" class="clear-filters-btn" (click)="clearAirlineFilters()">
              Xóa tất cả
            </button>
          </div>
          <div class="airline-filters">
            <label *ngFor="let airline of airlines">
              <input type="checkbox" [(ngModel)]="airline.selected" (change)="filterFlights()" />
              {{ airline.name }}
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Flight results -->
    <div class="flight-results">
      <!-- Flight Info Card -->
      <div class="flight-info-card">
        <!-- Flight Route Section -->
        <div class="flight-route-section">
          <div class="flight-info">
            <mat-icon class="flight-icon">flight_takeoff</mat-icon>
            <div class="route-info">
              <div class="route">
                <span class="airport">{{ getAirportName(searchParams.departure) }} ({{ searchParams.departure }})</span>
                <mat-icon class="arrow-icon">arrow_forward</mat-icon>
                <span class="airport">{{ getAirportName(searchParams.destination) }} ({{ searchParams.destination }})</span>
              </div>
              <div class="selected-date">{{ getFormattedDate() }}</div>
            </div>
          </div>
          <div class="collapse-toggle" (click)="toggleFlightsCollapse()">
            <mat-icon>{{ isFlightsCollapsed ? 'add' : 'remove' }}</mat-icon>
          </div>
        </div>
        
        <!-- Separator Line -->
        <div class="separator-line"></div>
        
        <!-- Date Selector Section -->
        <!-- <div class="date-selector-section">
          <div class="date-selector">
            <div class="date-item" *ngFor="let date of availableDates" 
                 [class.active]="date.isSelected" 
                 (click)="selectDate(date)">
              <span class="day">{{ date.dayName }}</span>
              <span class="date">{{ date.dayNumber }}</span>
            </div>
          </div>
        </div> -->
        
        <!-- Flight cards -->
        <div class="flights-list" *ngIf="!isFlightsCollapsed">
          @if (isLoading) {
            <div class="loading-message">
              <p>Đang tải danh sách chuyến bay...</p>
            </div>
          } @else if (filteredFlights.length > 0) {
            <app-flight-card 
              *ngFor="let flight of filteredFlights" 
              [flight]="flight"
              [isSelected]="isFlightSelected(flight, false)"
              (flightSelected)="selectDepartureFlight($event)">
            </app-flight-card>
          } @else if (searchResult && apiFlights.length === 0) {
            <div class="no-flights-message">
              <p>Không tìm thấy chuyến bay phù hợp với yêu cầu của bạn.</p>
            </div>
          } @else {
            <div class="no-flights-message">
              <p>Vui lòng tìm kiếm chuyến bay để xem kết quả.</p>
            </div>
          }
        </div>
      </div>

      <!-- Return Flight Info Card (only for roundtrip) -->
      <div class="flight-info-card return-flight" *ngIf="tripType === 'roundtrip'">
        <!-- Return Flight Route Section -->
        <div class="flight-route-section">
          <div class="flight-info">
            <mat-icon class="flight-icon">flight_land</mat-icon>
            <div class="route-info">
              <div class="route">
                <span class="airport">{{ getAirportName(searchParams.destination) }} ({{ searchParams.destination }})</span>
                <mat-icon class="arrow-icon">arrow_forward</mat-icon>
                <span class="airport">{{ getAirportName(searchParams.departure) }} ({{ searchParams.departure }})</span>
              </div>
              <div class="selected-date">{{ getFormattedReturnDate() }}</div>
            </div>
          </div>
          <div class="collapse-toggle" (click)="toggleReturnFlightsCollapse()">
            <mat-icon>{{ isReturnFlightsCollapsed ? 'add' : 'remove' }}</mat-icon>
          </div>
        </div>
        
        <!-- Separator Line -->
        <div class="separator-line"></div>
        
        <!-- Date Selector Section for Return -->
        <!-- <div class="date-selector-section">
          <div class="date-selector">
            <div class="date-item" *ngFor="let date of availableDates" 
                 [class.active]="date.isSelected" 
                 (click)="selectDate(date)">
              <span class="day">{{ date.dayName }}</span>
              <span class="date">{{ date.dayNumber }}</span>
            </div>
          </div>
        </div> -->
        
        <!-- Return Flight cards -->
        <div class="flights-list" *ngIf="!isReturnFlightsCollapsed">
          @if (filteredReturnFlights.length > 0) {
            <app-flight-card 
              *ngFor="let flight of filteredReturnFlights" 
              [flight]="flight"
              [isSelected]="isFlightSelected(flight, true)"
              (flightSelected)="selectReturnFlight($event)">
            </app-flight-card>
          } @else {
            <div class="no-flights-message">
              <p>Không tìm thấy chuyến bay về phù hợp.</p>
            </div>
          }
        </div>
      </div>
    </div>
  </div>
</div>
