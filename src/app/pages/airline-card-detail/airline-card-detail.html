<app-header></app-header>

<!-- Booking Information Section -->
<div class="booking-container">
  <!-- Header -->
  <!-- <div class="booking-header">
    <h1>Thông tin đặt chỗ</h1>
    <p>Hoàn tất thông tin để đặt vé</p>
  </div> -->

  <!-- Progress Steps -->
  <div class="progress-steps">
    <div [ngClass]="getStepClass(1)">
      <div class="step-circle">
        1
      </div>
      <span>Thông tin hành khách</span>
    </div>
    <div class="step-line" [ngClass]="isStepCompleted(1) ? 'completed' : ''"></div>
    <div [ngClass]="getStepClass(2)">
      <div class="step-circle">2</div>
      <span>Liên hệ & Yêu cầu</span>
    </div>
    <div class="step-line" [ngClass]="isStepCompleted(2) ? 'completed' : ''"></div>
    <div [ngClass]="getStepClass(3)">
      <div class="step-circle">3</div>
      <span>Thanh toán</span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="booking-content">
    <!-- Left Column - Dynamic Content based on current step -->
    <div class="passenger-info">
      
      <!-- Step 1: Passenger Information -->
      @if (currentStep === 1) {
        <div class="section-header">
          <!-- <i class="fas fa-user"></i> -->
          <h2>Thông tin hành khách</h2>
        </div>

        <!-- Dynamic Passenger Cards -->
        @for (passenger of passengerForms; track passenger.id; let i = $index) {
          <div class="passenger-card" [class]="'passenger-type-' + passenger.passengerType.toLowerCase()">
            <div class="passenger-header">
              <h3>Hành khách {{ i + 1 }}</h3>
              <span class="passenger-type-badge">{{ passenger.passengerTypeLabel }}</span>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Danh xưng *</label>
                <select [(ngModel)]="passenger.title" (change)="clearErrors()">
                  <option value="">Chọn</option>
                  <option value="mr">Ông</option>
                  <option value="ms">Bà</option>
                  <option value="miss">Cô/Chị</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Họ và tên đệm *</label>
                <input type="text" placeholder="Nhập họ và tên đệm" [(ngModel)]="passenger.firstName" (input)="clearErrors()">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Tên *</label>
                <input type="text" placeholder="Nhập tên" [(ngModel)]="passenger.lastName" (input)="clearErrors()">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Ngày sinh *</label>
                <input 
                  type="date" 
                  [(ngModel)]="passenger.birthDate"
                  [min]="getMinBirthDate(passenger.passengerType)"
                  [max]="getMaxBirthDate(passenger.passengerType)"
                  (change)="clearErrors()">
                <div class="age-info">
                  @if (passenger.passengerType === 'ADULT') {
                    <span class="age-text">Từ 13 tuổi trở lên</span>
                  } @else if (passenger.passengerType === 'CHILD') {
                    <span class="age-text">Từ 2-12 tuổi</span>
                  } @else if (passenger.passengerType === 'INFANT') {
                    <span class="age-text">Dưới 2 tuổi</span>
                  }
                </div>
              </div>
            </div>

            <!-- CMND/CCCD - chỉ hiển thị cho người lớn -->
            @if (passenger.passengerType === 'ADULT') {
              <div class="form-row">
                <div class="form-group">
                  <label>CMND/CCCD *</label>
                  <input type="text" placeholder="Nhập số CMND/CCCD" [(ngModel)]="passenger.idNumber" (input)="clearErrors()">
                </div>
              </div>
            }

            <!-- Email - chỉ hiển thị cho người lớn -->
            @if (passenger.passengerType === 'ADULT') {
              <div class="form-row">
                <div class="form-group">
                  <label>Email *</label>
                  <input type="email" placeholder="Nhập email" [(ngModel)]="passenger.email" (input)="clearErrors()">
                </div>
              </div>
            }

            <!-- Số điện thoại - chỉ hiển thị cho người lớn -->
            @if (passenger.passengerType === 'ADULT') {
              <div class="form-row">
                <div class="form-group">
                  <label>Số điện thoại</label>
                  <input type="tel" placeholder="Nhập số điện thoại" [(ngModel)]="passenger.phone">
                </div>
              </div>
            }

            <!-- Information Alert for first passenger only -->
            @if (i === 0) {
              <div class="info-alert">
                <div class="alert-icon">
                  <!-- <i class="fas fa-info-circle"></i> -->
                </div>
                <p>Vui lòng nhập thông tin chính xác theo giấy tờ tùy thân. Thông tin sai có thể dẫn đến từ chối check-in.</p>
                @if (passenger.passengerType === 'CHILD' || passenger.passengerType === 'INFANT') {
                  <p><strong>Lưu ý:</strong> Trẻ em và em bé không cần CMND/CCCD, số điện thoại và email riêng.</p>
                }
              </div>
            }
          </div>
        }
      }

      <!-- Step 2: Contact Information -->
      @if (currentStep === 2) {
        <div class="section-header">
          <!-- <i class="fas fa-phone"></i> -->
          <h2>Thông tin liên hệ & Yêu cầu đặc biệt</h2>
        </div>

        <!-- Contact Information -->
        <div class="contact-card">
          <h3>Thông tin liên hệ</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label>Danh xưng *</label>
              <select [(ngModel)]="contactInfo.title" (change)="clearErrors()">
                <option value="">Chọn</option>
                <option value="mr">Ông</option>
                <option value="ms">Bà</option>
                <option value="miss">Cô/Chị</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Họ và tên *</label>
              <input type="text" placeholder="Nhập họ và tên đầy đủ" [(ngModel)]="contactInfo.fullName" (input)="clearErrors()">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Số điện thoại *</label>
              <input type="tel" placeholder="Nhập số điện thoại" [(ngModel)]="contactInfo.phone" (input)="clearErrors()">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Email *</label>
              <input type="email" placeholder="Nhập email" [(ngModel)]="contactInfo.email" (input)="clearErrors()">
            </div>
          </div>
        </div>

        <!-- Special Requests -->
        <!-- <div class="special-requests-card">
          <h3>Yêu cầu đặc biệt (tuỳ chọn)</h3>
          <div class="form-group">
            <textarea 
              placeholder="Suất ăn chay, hỗ trợ xe lăn, ghế gần lối đi..." 
              [(ngModel)]="specialRequests"
              rows="4"></textarea>
          </div>
        </div> -->

        <!-- Additional Services -->
        <!-- <div class="additional-services-card">
          <h3>Dịch vụ bổ sung</h3>
          
          <div class="service-item">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="additionalServices.specialMeal">
              <span class="checkmark"></span>
              <span class="service-text">Suất ăn đặc biệt (+150.000 VND)</span>
            </label>
          </div>

          <div class="service-item">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="additionalServices.extraLuggage">
              <span class="checkmark"></span>
              <span class="service-text">Hành lý thêm 15kg (+300.000 VND)</span>
            </label>
          </div>

          <div class="service-item">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="additionalServices.seatSelection">
              <span class="checkmark"></span>
              <span class="service-text">Chọn ghế ngồi (+200.000 VND)</span>
            </label>
          </div>
        </div> -->
      }

      <!-- Step 3: Payment -->
      @if (currentStep === 3) {
        <div class="section-header">
          <!-- <i class="fas fa-credit-card"></i> -->
          <h2>Thanh toán</h2>
        </div>

        <!-- Booking Overview -->
        <div class="overview-card">
          <h3>Tổng hợp đặt vé</h3>
          
          <!-- Passenger Info -->
          <div class="overview-section">
            <h4>Thông tin hành khách ({{ getTotalPassengerCount() }} người)</h4>
            @for (passenger of passengerForms; track passenger.id; let i = $index) {
              <div class="passenger-overview">
                <div class="passenger-overview-header">
                  <span class="passenger-number">Hành khách {{ i + 1 }}</span>
                  <span class="passenger-type-badge">{{ passenger.passengerTypeLabel }}</span>
                </div>
                <div class="overview-item">
                  <span class="label">Họ tên:</span>
                  <span class="value">{{ getPassengerDisplayNames()[i] }}</span>
                </div>
                <div class="overview-item">
                  <span class="label">Ngày sinh:</span>
                  <span class="value">{{ passenger.birthDate | date:'dd/MM/yyyy' }}</span>
                </div>
                @if (passenger.passengerType === 'ADULT') {
                  <div class="overview-item">
                    <span class="label">CMND/CCCD:</span>
                    <span class="value">{{ passenger.idNumber }}</span>
                  </div>
                }
              </div>
            }
          </div>

          <!-- Contact Info -->
          <div class="overview-section">
            <h4>Thông tin liên hệ</h4>
            <div class="overview-item">
              <span class="label">Người liên hệ:</span>
              <span class="value">{{ getContactDisplayName() }}</span>
            </div>
            <div class="overview-item">
              <span class="label">Số điện thoại:</span>
              <span class="value">{{ contactInfo.phone }}</span>
            </div>
            <div class="overview-item">
              <span class="label">Email:</span>
              <span class="value">{{ contactInfo.email }}</span>
            </div>
          </div>

          <!-- Flight Info -->
          <!-- <div class="overview-section">
            <h4>Thông tin chuyến bay</h4>
            @if (selectedFlight) {
              <div class="overview-item">
                <span class="label">Hãng hàng không:</span>
                <span class="value">{{ selectedFlight.airline || 'Unknown Airline' }} - {{ selectedFlight.flight_number || selectedFlight.code || 'N/A' }}</span>
              </div>
              <div class="overview-item">
                <span class="label">Tuyến bay:</span>
                <span class="value">{{ selectedFlight.departure?.airport?.city || selectedFlight.departAirport || 'N/A' }} → {{ selectedFlight.arrival?.airport?.city || selectedFlight.arriveAirport || 'N/A' }}</span>
              </div>
              <div class="overview-item">
                <span class="label">Ngày bay:</span>
                <span class="value">{{ getFlightDate() }}</span>
              </div>
              <div class="overview-item">
                <span class="label">Thời gian:</span>
                <span class="value">{{ getFlightTimeDisplay() }}</span>
              </div>
              <div class="overview-item">
                <span class="label">Thời gian bay:</span>
                <span class="value">{{ getFlightDurationDisplay() }}</span>
              </div>
            } @else {
              <div class="overview-item">
                <span class="value">Không có thông tin chuyến bay</span>
              </div>
            }
          </div> -->

          <!-- Special Requests -->
          @if (specialRequests) {
            <div class="overview-section">
              <h4>Yêu cầu đặc biệt</h4>
              <div class="overview-item">
                <span class="value">{{ specialRequests }}</span>
              </div>
            </div>
          }

          <!-- Additional Services -->
          @if (hasAdditionalServices()) {
            <div class="overview-section">
              <h4>Dịch vụ bổ sung</h4>
              @if (additionalServices.specialMeal) {
                <div class="overview-item">
                  <span class="value">Suất ăn đặc biệt (+150.000 VND)</span>
                </div>
              }
              @if (additionalServices.extraLuggage) {
                <div class="overview-item">
                  <span class="value">Hành lý thêm 15kg (+300.000 VND)</span>
                </div>
              }
              @if (additionalServices.seatSelection) {
                <div class="overview-item">
                  <span class="value">Chọn ghế ngồi (+200.000 VND)</span>
                </div>
              }
            </div>
          }
        </div>

        <!-- Payment Method -->
        <div class="payment-card">
          <h3>Phương thức thanh toán</h3>
          
          <div class="payment-method">
            <div class="sepay-payment">
              <div class="sepay-header">
                <div class="sepay-logo">
                  <img width="40px" height="40px" src="./assets/images/QR_SePay.png" alt="SePay Logo">
                </div>
                <div class="sepay-info">
                  <h4>SePay</h4>
                  <p>Quét mã QR để thanh toán</p>
                </div>
              </div>
              
              <div class="payment-amount">
                <div class="amount-detail">
                  <span class="label">Tổng thanh toán:</span>
                  <span class="amount">{{ getTotalAmount() | currency:'VND':'symbol':'1.0-0' }}</span>
                </div>
              </div>
              
              <div class="qr-section">
                <div class="qr-code">
                  <img src="./assets/images/QR_SePay.png" alt="SePay QR Code" class="qr-image">
                  <p class="qr-instruction">Quét mã QR bằng ứng dụng ngân hàng để thanh toán</p>
                </div>
                <!-- Bank account info -->
                <div class="bank-info">
                  <div class="row">
                    <span class="label">Tên tài khoản:</span>
                    <span class="value">TRINH TU HAO</span>
                  </div>
                  <div class="row">
                    <span class="label">Số tài khoản:</span>
                    <span class="value code">00001998136</span>
                  </div>
                  <div class="row">
                    <span class="label">Ngân hàng:</span>
                    <span class="value">TPBank</span>
                  </div>
                </div>
              </div>

              <!-- Loading while creating booking and preparing countdown -->
              @if (isCreatingBooking && !paymentWaiting) {
                <div class="loading-box">
                  <mat-spinner diameter="26"></mat-spinner>
                  <div class="loading-text">Đang khởi tạo mã đặt chỗ và bộ đếm thời gian...</div>
                </div>
              }

              <!-- Payment instruction with PNR for transfer content -->
              @if (paymentWaiting && bookingResult?.booking?.pnr_code) {
                <div class="transfer-instruction">
                  <div class="instruction-row">
                    <span class="label">Mã đặt chỗ (PNR):</span>
                    <span class="value code">{{ getBookingPNR() }}</span>
                    <button class="icon-btn" (click)="copyText(getBookingPNR())" aria-label="Sao chép PNR">
                      <mat-icon class="material-symbols-outlined">content_copy</mat-icon>
                    </button>
                  </div>
                  <div class="instruction-row">
                    <span class="label">Nội dung chuyển khoản:</span>
                    <span class="value">Thanh toan cho PNR{{ getBookingPNR() }}</span>
                    <button class="icon-btn" (click)="copyText('Thanh toan cho PNR' + getBookingPNR())" aria-label="Sao chép nội dung">
                      <mat-icon class="material-symbols-outlined">content_copy</mat-icon>
                    </button>
                  </div>
                  <div class="hint">Vui lòng nhập đúng nội dung để hệ thống tự động xác nhận thanh toán.</div>
                </div>
              }

              <!-- Payment waiting countdown -->
              @if (paymentWaiting) {
                <div class="countdown-box">
                  <div class="countdown-title">Vui lòng hoàn tất thanh toán trong</div>
                  <div class="countdown-time">
                    {{ (paymentTimeLeftSec/60) | number:'2.0-0' }}:
                    {{ (paymentTimeLeftSec%60) | number:'2.0-0' }}
                  </div>
                  <div class="countdown-note">Sau khi thanh toán thành công, hệ thống sẽ tự động xác nhận và chuyển bạn sang trang vé.</div>
                </div>
              }
            </div>
          </div>
        </div>
      }
    </div>

    <!-- Right Column - Flight Details -->
    <div class="flight-summary">
      <h2>Chi tiết chuyến bay</h2>
      
      @if (selectedFlight) {
        <!-- Departure Flight -->
        <div class="flight-section">
          <h3>Chuyến bay đi</h3>
          <div class="airline-info">
            <div class="airline-logo">
              <img [src]="selectedFlight.logo || '/assets/images/logo.png'" [alt]="selectedFlight.airline || 'Unknown Airline'" width="40px" height="40px">
            </div>
            <div class="airline-details">
              <h3>{{ selectedFlight.airline || 'Unknown Airline' }}</h3>
              <p>{{ selectedFlight.code || selectedFlight.flight_id }}</p>
            </div>
          </div>

          <div class="flight-details">
            <div class="detail-item">
              <span class="label">Ngày bay:</span>
              <span class="value">{{ getFlightDate() }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Tuyến bay:</span>
              <span class="value">{{ selectedFlight.departAirport || 'N/A' }} → {{ selectedFlight.arriveAirport || 'N/A' }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Thời gian:</span>
              <span class="value">{{ getFlightTimeDisplay() }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Thời gian bay:</span>
              <span class="value">{{ getFlightDurationDisplay() }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Hành khách:</span>
              <span class="value">{{ getTotalPassengerCount() }} người</span>
            </div>
          </div>
        </div>

        <!-- Return Flight (if roundtrip) -->
        @if (tripType === 'roundtrip' && selectedReturnFlight) {
          <div class="flight-section">
            <h3>Chuyến bay về</h3>
            <div class="airline-info">
              <div class="airline-logo">
                <img [src]="selectedReturnFlight.logo || '/assets/images/logo.png'" [alt]="selectedReturnFlight.airline || 'Unknown Airline'" width="40px" height="40px">
              </div>
              <div class="airline-details">
                <h3>{{ selectedReturnFlight.airline || 'Unknown Airline' }}</h3>
                <p>{{ selectedReturnFlight.code || selectedReturnFlight.flight_id }}</p>
              </div>
            </div>

            <div class="flight-details">
              <div class="detail-item">
                <span class="label">Ngày bay:</span>
                <span class="value">{{ getReturnFlightDate() }}</span>
              </div>
              <div class="detail-item">
                <span class="label">Tuyến bay:</span>
                <span class="value">{{ selectedReturnFlight.departAirport || 'N/A' }} → {{ selectedReturnFlight.arriveAirport || 'N/A' }}</span>
              </div>
              <div class="detail-item">
                <span class="label">Thời gian:</span>
                <span class="value">{{ getReturnFlightTimeDisplay() }}</span>
              </div>
              <div class="detail-item">
                <span class="label">Thời gian bay:</span>
                <span class="value">{{ getReturnFlightDurationDisplay() }}</span>
              </div>
            </div>
          </div>
        }

        <!-- Price Breakdown -->
        <div class="price-breakdown">
          @if (hasSelectedFare()) {
            <!-- Use selected fare price from dialog (most accurate) -->
            <div class="price-item">
              <span>Chuyến đi - {{ getSelectedFareClass() }}:</span>
              <span>{{ formatPrice(getSelectedFarePrice()) }} ₫</span>
            </div>
            
            @if (tripType === 'roundtrip' && hasSelectedReturnFare()) {
              <div class="price-item">
                <span>Chuyến về - {{ getSelectedReturnFareClass() }}:</span>
                <span>{{ formatPrice(getSelectedReturnFarePrice()) }} ₫</span>
              </div>
            } @else if (tripType === 'roundtrip' && selectedReturnFlight) {
              <div class="price-item">
                <span>Chuyến về:</span>
                <span>{{ formatPrice(calculateFlightPrice(selectedReturnFlight)) }} ₫</span>
              </div>
            }
            
            <div class="price-item">
              <span>Số hành khách:</span>
              <span>{{ getTotalPassengerCount() }} người</span>
            </div>
            <div class="price-item total">
              <span>Tổng cộng:</span>
              <span>{{ formatPrice(getTotalAmount()) }} ₫</span>
            </div>
          } @else if (selectedFlight.pricing && selectedFlight.pricing.breakdown) {
            <!-- Use real pricing data from API -->
            <div class="price-item">
              <span>Giá vé cơ bản:</span>
              <span>{{ formatPrice(selectedFlight.pricing?.base_price || 0) }} ₫</span>
            </div>
            
            @if (selectedFlight.pricing?.breakdown?.adults && selectedFlight.pricing.breakdown.adults.count > 0) {
              <div class="price-item">
                <span>Người lớn ({{ selectedFlight.pricing.breakdown.adults.count }} x {{ formatPrice(selectedFlight.pricing.breakdown.adults.unit_price) }} ₫):</span>
                <span>{{ formatPrice(selectedFlight.pricing.breakdown.adults.total) }} ₫</span>
              </div>
            }
            
            @if (selectedFlight.pricing?.breakdown?.children && selectedFlight.pricing.breakdown.children.count > 0) {
              <div class="price-item">
                <span>Trẻ em ({{ selectedFlight.pricing.breakdown.children.count }} x {{ formatPrice(selectedFlight.pricing.breakdown.children.unit_price) }} ₫):</span>
                <span>{{ formatPrice(selectedFlight.pricing.breakdown.children.total) }} ₫</span>
              </div>
            }
            
            @if (selectedFlight.pricing?.breakdown?.infants && selectedFlight.pricing.breakdown.infants?.count && (selectedFlight.pricing.breakdown.infants?.count || 0) > 0) {
              <div class="price-item">
                <span>Em bé ({{ selectedFlight.pricing.breakdown.infants?.count }} x {{ formatPrice(selectedFlight.pricing.breakdown.infants?.unit_price || 0) }} ₫):</span>
                <span>{{ formatPrice(selectedFlight.pricing.breakdown.infants?.total || 0) }} ₫</span>
              </div>
            }
            
            <div class="price-item total">
              <span>Tổng cộng:</span>
              <span>{{ formatPrice(selectedFlight.pricing?.total_price || 0) }} ₫</span>
            </div>
          } @else if (selectedFlight.fares && selectedFlight.fares.length > 0) {
            <!-- Fallback: Use first available fare -->
            <div class="price-item">
              <span>Chuyến đi - {{ selectedFlight.fares[0].fare_bucket?.class_type || 'Economy' }}:</span>
              <span>{{ formatPrice(selectedFlight.fares[0].base_price) }} ₫</span>
            </div>
            
            @if (tripType === 'roundtrip' && selectedReturnFlight && selectedReturnFlight.fares && selectedReturnFlight.fares.length > 0) {
              <div class="price-item">
                <span>Chuyến về - {{ selectedReturnFlight.fares[0].fare_bucket?.class_type || 'Economy' }}:</span>
                <span>{{ formatPrice(selectedReturnFlight.fares[0].base_price) }} ₫</span>
              </div>
            }
            
            <div class="price-item">
              <span>Số hành khách:</span>
              <span>{{ getTotalPassengerCount() }} người</span>
            </div>
            <div class="price-item total">
              <span>Tổng cộng (ước tính):</span>
              <span>{{ formatPrice(getTotalAmount()) }} ₫</span>
            </div>
          } @else {
            <!-- No pricing data available -->
            <div class="price-item">
              <span>Không có thông tin giá</span>
              <span>Liên hệ để biết giá</span>
            </div>
          }
        </div>
      } @else {
        <div class="no-flight-data">
          <p>Không có thông tin chuyến bay</p>
        </div>
      }
    </div>
  </div>

  <!-- Error Messages -->
  @if (errorMessages.length > 0) {
    <div class="error-messages">
      <h4>Lỗi:</h4>
      <ul>
        <li *ngFor="let error of errorMessages">{{ error }}</li>
      </ul>
    </div>
  }

  <!-- Footer Navigation -->
  <div class="booking-footer">
    <button class="btn-secondary" (click)="previousStep()" [disabled]="isCreatingBooking || paymentWaiting">Quay lại</button>
    @if (currentStep < 3) {
      <button class="btn-primary" (click)="nextStep()" [disabled]="isCreatingBooking">Tiếp tục</button>
    }
    <!-- Khi ở bước 3, không hiển thị nút tạo booking; flow chạy tự động -->
  </div>
</div>
